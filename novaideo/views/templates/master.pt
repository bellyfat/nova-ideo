<!DOCTYPE html>
<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:define-macro="main"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="novaideo"
      tal:define="mp request.sdiapi.mgmt_path;
      su request.static_url;
      notification_ids getattr(request.user, 'notification_ids', []);
      activate_push_notification getattr(request.root, 'activate_push_notification', False);
      app_id getattr(request.root, 'app_id', None);
      root_title getattr(request.root, 'title', '');
      root_data layout.get_root();
      root_url root_data['root_url'];
      node_env root_data['node_env']">
  <head >
    <meta charset="utf-8"/>
    <title metal:define-slot="page-title">${root_title}</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0"/>
    <link type="text/css" rel="stylesheet"  tal:condition="node_env == 'production'" href="${root_url}/build/novaideo.css" />
    <link type="text/css" rel="stylesheet"  tal:condition="node_env == 'production'" href="${root_url}/build/bundle.css" />
    <div tal:omit-tag="" tal:condition="request.user and activate_push_notification and app_id">
      <link rel="manifest" href="${request.resource_url(request.root, 'manifest.json')}">
      <script src="${su('novaideo:static/js/OneSignalSDK.js')}" async></script>
      <script>
        var OneSignal = OneSignal || [];
        OneSignal.push(["init", {
          appId: "${app_id}",
          autoRegister: true,
          notifyButton: {
            enable: false /* Set to false to hide */
          }
        }]);
      </script>
    </div>

    <script type="text/javascript" tal:condition="request.user and activate_push_notification and app_id">
        var OneSignal = OneSignal || [];
        OneSignal.getIdsAvailable(function(ids) {
          <tal:block condition="notification_ids">
            var current_ids = [${','.join(["\'"+i+"\'" for i in
                                           notification_ids]) }]
          </tal:block>
          <tal:block condition="not notification_ids">
            var current_ids = []
          </tal:block>
          if($.inArray(ids.userId, current_ids) < 0){
            update_notification_id(
              ids.userId,
              '${request.resource_url(request.root, 'novaideoapi', query={'op': 'update_notification_id'})}')
          }
        });
    </script>
    <link rel="stylesheet" href="//cdn.materialdesignicons.com/2.1.19/css/materialdesignicons.min.css">
  </head>
  <body>
    <input type="hidden" name="execution-id" id="execution-id" value="" />
    <div id='root'></div>
    <div id='modal-portal'></div>
    <script src="${root_url}/build/bundle.js"></script>
    <script tal:condition="node_env == 'development'" src="${root_url}/build/novaideo.js"></script>
  </body>
</html>
